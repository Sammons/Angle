<!DOCTYPE html>
<html>
<head>
	<title>Angle</title>
	<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
	<script type="text/javascript">
	//top level things
	$(document).ready(function() {
		var socket = new WebSocket("ws://localhost:5001/");
		var beginRendering = false;
		var gameJoined = false;
		var gameDetails = {};
		var present = true;
		var canvas = document.getElementById('canvas');
		canvas.width = 500;
		canvas.height = 500;
		var context = canvas.getContext('2d');
		var inMemCanvas = document.createElement("canvas");
		 inMemCanvas.width = 25;
		 inMemCanvas.height = 10;
		var inMemContext = inMemCanvas.getContext("2d");
		socket.onmessage = function(message) {
			data = JSON.parse(message.data);
			gameDetails[data["topic"]] = data["value"];
			if (data.topic == "players")  {
				var canvas = document.getElementById('canvas');
				var context = canvas.getContext('2d');	
				context.clearRect(0,0,canvas.width,canvas.height);
				for (pk in data["value"]) {
					if (pk != "count") {
						var imgData=inMemContext.createImageData(15,10);
						for (var i=0;i<imgData.data.length;i+=4)
						{
							imgData.data[i+0]=data["value"][pk].imgData[i+0];
							imgData.data[i+1]=data["value"][pk].imgData[i+1];
							imgData.data[i+2]=data["value"][pk].imgData[i+2];
							imgData.data[i+3]=data["value"][pk].imgData[i+3];
						}
						imgData.data = data["value"][pk].imgData;
						inMemContext.putImageData(imgData,0,0);
						renderPlayer(data["value"][pk],context,inMemCanvas);
					}
				}
			}
		};
		function renderPlayer (player,context,image) {
			context.translate(player.x,player.y);
			context.rotate(player.netTheta/180*Math.PI);
			context.drawImage(image,0,0);
			context.rotate(-player.netTheta/180*Math.PI);
			context.translate(-(player.x),-(player.y));
			for (var i = player.bodyPixels.length - 1; i >= 0; i--) {
				context.fillRect(player.bodyPixels[i].x,player.bodyPixels[i].y,1,1);
			};
			//context.fillRect(player.bodyPixels[player.bodyPixels.length-1].x,player.bodyPixels[player.bodyPixels.length-1].y,1,1);
			//context.fillRect(player.bodyPixels[0].x,player.bodyPixels[0].y,1,1);
		}
		var sendMessage = function(message) {
			message["sent"] = Date.now();
			var d = JSON.stringify(message);
			socket.send(d);
		};
		

		$("#submit").click(function() {
			//$("#submit").remove();

				//just once, send beginning info
				var intro = {
					"topic" : "intro",
					"name" : $("#name").val()
				}
				sendMessage(intro);
				
				var enterGame = {"topic":"connected", "value":true}
				//sendMessage(enterGame);

				$(window).keydown(function(e) {
					e.preventDefault();
					var msg = {"topic": "keydown", "value": e.which}
					sendMessage(msg);
				});
				
				setInterval(function() {
					var msg ={"topic" : "heartbeat", "value" : "alive"};
					if (present) sendMessage(msg);
				},50);
				if (gameDetails.rules.timeoutPlayers) {

					$(window).blur(function() {
						present = false;
					});

					$(window).focus(function() {
						present = true;
					});
				}
			});
		});
	</script>
	<script type="text/javascript" src="/r1"></script>
	<script type="text/javascript" src="/r2"></script>
	<script type="text/javascript" src="/r3"></script>

</head>
<body>
<header>Welcome</header>
<form>
	<input type="text" name="name" id="name" placeholder="type username here"/>
	<input type="submit" name="submit" id="submit" value="play" onclick="return false;">
</form>
<canvas id="canvas" width="500px" height="500px" style="border: 1px solid green;">
	
</canvas>
</body>
</html>